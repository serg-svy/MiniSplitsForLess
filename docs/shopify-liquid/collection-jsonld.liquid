{% comment %}
  MiniSplitsForLess - Collection JSON-LD Schema
  
  Place this snippet in your collection.liquid template or include it via:
  {% render 'collection-jsonld' %}
  
  Supports:
  - ItemList structured data for collection pages
  - Individual product entries with pricing
  - Collection metadata
{% endcomment %}

{% if collection %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": {{ collection.title | json }},
  "description": {{ collection.description | strip_html | truncate: 500 | default: collection.title | json }},
  "url": "{{ shop.url }}{{ collection.url }}",
  {% if collection.image %}
  "image": {{ collection.image | image_url: width: 1200 | json }},
  {% endif %}
  "mainEntity": {
    "@type": "ItemList",
    "name": {{ collection.title | json }},
    "description": {{ collection.description | strip_html | truncate: 300 | default: collection.title | json }},
    "numberOfItems": {{ collection.products_count }},
    "itemListElement": [
      {% for product in collection.products limit: 30 %}
      {
        "@type": "ListItem",
        "position": {{ forloop.index }},
        "url": "{{ shop.url }}{{ product.url }}",
        "name": {{ product.title | json }},
        "item": {
          "@type": "Product",
          "name": {{ product.title | json }},
          "url": "{{ shop.url }}{{ product.url }}",
          {% if product.featured_image %}
          "image": {{ product.featured_image | image_url: width: 800 | json }},
          {% endif %}
          "description": {{ product.description | strip_html | truncate: 200 | json }},
          {% if product.vendor != blank %}
          "brand": {
            "@type": "Brand",
            "name": {{ product.vendor | json }}
          },
          {% endif %}
          "sku": {{ product.selected_or_first_available_variant.sku | json }},
          "offers": {
            "@type": "Offer",
            "url": "{{ shop.url }}{{ product.url }}",
            "priceCurrency": {{ cart.currency.iso_code | json }},
            "price": {{ product.price | money_without_currency | remove: ',' | json }},
            {% if product.compare_at_price > product.price %}
            "priceValidUntil": "{{ 'now' | date: '%Y' | plus: 1 }}-12-31",
            {% endif %}
            {% if product.available %}
            "availability": "https://schema.org/InStock",
            {% else %}
            "availability": "https://schema.org/OutOfStock",
            {% endif %}
            "itemCondition": "https://schema.org/NewCondition",
            "seller": {
              "@type": "Organization",
              "name": {{ shop.name | json }}
            }
          }
          {% comment %} Include aggregate rating if available {% endcomment %}
          {% if product.metafields.reviews.rating.value != blank and product.metafields.reviews.rating_count.value > 0 %}
          ,"aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": {{ product.metafields.reviews.rating.value | json }},
            "reviewCount": {{ product.metafields.reviews.rating_count.value | json }},
            "bestRating": "5",
            "worstRating": "1"
          }
          {% endif %}
        }
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
}
</script>

{% comment %} Additional Offer Catalog Schema for Collections {% endcomment %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "OfferCatalog",
  "name": {{ collection.title | json }},
  "url": "{{ shop.url }}{{ collection.url }}",
  "numberOfItems": {{ collection.products_count }},
  "itemListElement": [
    {% for product in collection.products limit: 30 %}
    {
      "@type": "Offer",
      "itemOffered": {
        "@type": "Product",
        "name": {{ product.title | json }},
        "url": "{{ shop.url }}{{ product.url }}"
      },
      "priceCurrency": {{ cart.currency.iso_code | json }},
      "price": {{ product.price | money_without_currency | remove: ',' | json }},
      {% if product.available %}
      "availability": "https://schema.org/InStock"
      {% else %}
      "availability": "https://schema.org/OutOfStock"
      {% endif %}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>
{% endif %}
